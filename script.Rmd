---
title: "script"
author: "Jeff Huang"
date: "6/26/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(janitor)
library(rpart)
library(randomForest)
library(ggplot2)

```

```{r}

train <- read.csv("training_set.csv") %>% 
  clean_names()

train <- train %>% 
  mutate(month = month(created),
         day = wday(created),
         year = year(created),
         hour = hour(created),
         num_people = str_count(description, "@"),
         num_hash = str_count(description, "#"))


```


```{r tests}

# 
# num_posts <- train %>% 
#   filter(year == 2018, hour == 11, playoffs, weekday) %>% 
#   group_by(year, month, day, hour) %>% 
#   mutate(posts_per_hour = n()) %>% 
#   
#   ggplot(aes(followers_at_posting, engagements)) +
#   geom_point(aes(color = posts_per_hour))

# bin scatter plot
#rdplot(narrow$yvar, narrow$school_enrollment, c = 40.5, nbins = 20) 

```


```{r}
# more descriptive time variables (in season, time of day, weekday)
train <- train %>% 
  mutate(weekday = ifelse(day %in% c(2:6), TRUE, FALSE),
         season = ifelse(month %in% c(10:12, 1:5), TRUE, FALSE),
         # rough
         playoffs = ifelse(month %in% c(4:6), TRUE, FALSE),
         time = ifelse(hour %in% c(8:11), "day", ifelse(hour %in% c(12:13), "lunch", ifelse(hour %in% c(14:16), "afternoon", ifelse(hour %in% c(17:24), "night", "none")))),
         followers = followers_at_posting
         ) %>% 
  mutate_if(is.character, as.factor)



# ranking of how famous people are



```


```{r tree and random forest}

vars = colnames(train[6:16])
videos <- train %>% filter(type == "Video")

one_tree <- rpart(reformulate(vars, "engagements")
                  , data=videos
                  , control = rpart.control(xval = 10)) ## this sets the number of folds for cross validation.
rank_hat_tree <- predict(one_tree, newdata=videos)
videos$tree <- rank_hat_tree
printcp(one_tree)



forest_hat <- randomForest(reformulate(vars, "engagements"), ntree=1000, mtry=11, maxnodes=100
                           ,importance=TRUE, do.trace=25, data=videos)
rank_hat_forest <- predict(forest_hat, newdata=videos,type="response")
videos$forest <- rank_hat_forest


# 6.7
forest_mape = mean(abs((videos$engagements - videos$forest)/videos$engagements)*100)

# 8.5
trees_mape = mean(abs((videos$engagements - videos$tree)/videos$engagements)*100)

```

